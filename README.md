[![current release version](https://img.shields.io/github/release/interline-io/planetutils.svg)](https://github.com/interline-io/planetutils/releases)
[![Docker Hub container image build status](https://img.shields.io/docker/build/interline/planetutils.svg)](https://hub.docker.com/r/interline/planetutils/)
[![CircleCI code test status](https://circleci.com/gh/interline-io/planetutils.svg?style=svg)](https://circleci.com/gh/interline-io/planetutils)

# Interline PlanetUtils

<!-- the following is generated by:
     1. npm install --save markdown-toc -g
     2. markdown-toc -i README.md
-->

<!-- toc -->

- [Features](#features)
- [Installation](#installation)
  * [Using Docker container](#using-docker-container)
  * [Using Homebrew on Mac OS](#using-homebrew-on-mac-os)
  * [Using Python package](#using-python-package)
- [Command-line Usage](#command-line-usage)
  * [osm_planet_update](#osm_planet_update)
  * [osm_planet_extract](#osm_planet_extract)
  * [osm_extract_download](#osm_extract_download)
  * [osm_planet_get_timestamp](#osm_planet_get_timestamp)
  * [elevation_tile_download](#elevation_tile_download)
  * [valhalla_tilepack_list](#valhalla_tilepack_list)
  * [valhalla_tilepack_download](#valhalla_tilepack_download)
- [Specifying bounding boxes](#specifying-bounding-boxes)
  * [Bounding box file: CSV format](#bounding-box-file-csv-format)
  * [Bounding box file: GeoJSON format](#bounding-box-file-geojson-format)
- [Support](#support)

<!-- tocstop -->

## Features

Python-based scripts and a Docker container to work with planet-scale geographic data. Using PlanetUtils, you can:

- maintain your own copy of the [OpenStreetMap](http://www.openstreetmap.org) planet (by applying incremental updates)
- cut your copy of the OSM planet into named bounding boxes
- download [OSM Extracts from Interline](https://www.interline.io/osm/extracts/) for popular cities and regions
- download [Mapzen Terrain Tiles from AWS](https://aws.amazon.com/public-datasets/terrain/) for the planet or your bounding boxes
- download [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks) for the planet (subscription required)

PlanetUtils is packaged for use as a:

- Docker container, for use on any operating system
- Python package, for use on any operating system
- Homebrew formula, for use on Mac OS

PlanetUtils is a "high level" library that makes use of [Osmosis](https://wiki.openstreetmap.org/wiki/Osmosis) and [OSM C tools](https://gitlab.com/osm-c-tools/osmctools/), among other great open-source components.

## Installation

### Using Docker container

Make sure you have [Docker](https://www.docker.com/community-edition) installed. Then:

```sh
docker pull interline/planetutils:release-v0.3.2
```

Any of the example commands below can be executed with `docker run`. It may be helpful to mount a local directory inside the container for persistence and to access output files.

- Example of using `docker run` with the `data` directory mounted as `/data`:

```sh
docker run --rm -v ${PWD}/data:/data -t interline/planetutils:release-v0.3.2 <command>
```

### Using Homebrew on Mac OS

Make sure you have [Homebrew](https://brew.sh/) installed. Then:

```sh
brew install interline-io/planetutils/planetutils
```

### Using Python package

If you want to install and use the Python package directly, you'll need to provide:

- Python 2.x
- Java
- [Osmosis](https://wiki.openstreetmap.org/wiki/Osmosis)
- [OSM C tools](https://gitlab.com/osm-c-tools/osmctools/)

Then clone this repo, run the tests, and install the Python package:

```sh
git clone https://github.com/interline-io/planetutils.git
python ./setup.py test
pip install .
```

## Command-line Usage

PlanetUtils supplies the following command-line utilities:

### osm_planet_update

Update a local OSM planet. For example:

```sh
osm_planet_update planet-recent.osm.pbf planet-with-updates.osm.pbf
```

If `planet-recent.osm.pbf` does not exist locally, the most recent planet file will be downloaded, before applying hourly updates to it. (Note: This download is nearly 40Gb.) By default, files are downloaded from planet.openstreetmap.org. Amazon Web Services also provides [OSM planets through its Public Datasets program](https://aws.amazon.com/public-datasets/osm/). To instead download the planet file from AWS:

1. Make sure you have your [AWS credentials configured locally](http://boto3.readthedocs.io/en/latest/guide/configuration.html).
2. Append the `--s3` flag.

Note that an entire OSM planet may be upwards of 40Gb in size! In other words, you should have ~80Gb free disk space before running this command.

For complete help on command-line arguments:

```sh
osm_planet_update -h
```

### osm_planet_extract

Cut up an OSM planet file into one or more extracts, defined by bounding boxes. Each bounding box is assigned a name. (This is like a mini version of Mapzen Metro Extracts!)

To create a single extract:

```sh
osm_planet_extract --outpath=data/osm_extracts --bbox=-122.737,37.449,-122.011,37.955 --name=san-francisco planet-latest.osm.pbf
```

To specify more than one bounding box of tiles to download, list the bounding boxes in a [CSV file or GeoJSON file](#bounding-box). For example:

```sh
osm_planet_extract --outpath=data/osm_extracts --csv=data/bboxes.csv planet-latest.osm.pbf
```

For complete help on command-line arguments:

```sh
osm_planet_extract -h
```

### osm_extract_download

Download regularly updated OSM extracts for popular cities and regions from [OSM Extracts by Interline](https://www.interline.io/osm/extracts). Browse available extracts using [the web interface]((https://www.interline.io/osm/extracts)) or [the GeoJSON file](https://github.com/interline-io/osm-extracts/blob/master/cities.geojson). Anyone can browse the available extracts or propose changes to the extract bounding boxes on [GitHub](https://github.com/interline-io/osm-extracts). A subscription is required to download extracts, to cover hosting costs and keep the service sustainable. (See the OSM Extracts website for more information on how profits are donated to OpenStreetMap and other "open" efforts.)

To download the latest copy of an extract (if `abcd` is your Interline API token and `abidjan_ivory-coast` is the ID for your chosen extract region):

```sh
osm_extract_download --api-token=abcd abidjan_ivory-coast
```

For complete help on command-line arguments:

```sh
osm_extract_download -h
```

(Note: OSM Extracts is a hosted and managed version of the PlanetUtils library. Every day, the pipeline runs the `osm_planet_update` and `osm_planet_extract` commands.)

### osm_planet_get_timestamp

A simple utility to print the timestamp of an OpenStreetMap PBF file.

```sh
osm_planet_get_timestamp planet-latest.osm.pbf
```

### elevation_tile_download

Download elevation tiles from the [Terrain Tiles in the AWS Public Datasets program](https://aws.amazon.com/public-datasets/terrain/). Download for the entire planet, only tiles within a single bounding box, or within multiple bounding boxes.

To download the entire planet of tiles (__which will require about 1.6Tb of space!__):

```sh
elevation_tile_download --outpath=data/elevation
```

To download tiles to cover a single bounding box:

```sh
elevation_tile_download --outpath=data/elevation --bbox=-122.737,37.449,-122.011,37.955
```

To specify more than one bounding box of tiles to download, list the bounding boxes in a [CSV file or GeoJSON file](#bounding-box). For example:

```sh
elevation_tile_download --outpath=data/elevation --csv=data/bboxes.csv
```

For complete help on command-line arguments:

```sh
elevation_tile_download -h
```

### valhalla_tilepack_list

Use [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/) to power your own instances of the [Valhalla routing engine](https://www.interline.io/valhalla/). Anyone can list available planet tilepacks. A subscription and an API key are required to [download tilepacks](#valhalla_tilepack_download).

To list all available planet tilepacks:

```sh
valhalla_tilepack_list
```

For complete help on command-line arguments:

```sh
valhalla_tilepack_list -h
```

### valhalla_tilepack_download

Download [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/) to power your own instances of the [Valhalla routing engine](https://www.interline.io/valhalla/). A subscription and an API key are required to download tilepacks.

Initial set-up:

1. Sign up for [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/).
2. Set your API token as an environment variable (`INTERLINE_API_TOKEN`) or use it as an argument to the command

To download the latest planet tilepack (if `abcd` is your Interline API token):

```sh
valhalla_tilepack_download --api-token=abcd
```

or set your API token as an environment variable, and download the latest planet tilepack:

```sh
export INTERLINE_API_TOKEN=abcd
valhalla_tilepack_download
```

For complete help on command-line arguments:

```sh
valhalla_tilepack_download -h
```

## Specifying bounding boxes
<a name="bounding-box"></a>

When extracting multiple bounding boxes from an OSM planet, or when downloading multiple bounding boxes of elevation tiles, you can specify your bounding boxes in a single file, either CSV or GeoJSON format.

### Bounding box file: CSV format

Do not include a header row. The format is as follows:

```csv
[name for extract],[left longitude],[bottom latitude],[right longitude],[top latitude]
```

For example:
```csv
san-francisco,-122.737,37.449,-122.011,37.955
dar-es-salaam,38.894,-7.120,39.661,-6.502
```

To determine a bounding box, try the tool at http://bboxfinder.com/

### Bounding box file: GeoJSON format

Alternatively, you can specify the bounding boxes as features in a GeoJSON file, using the `--geojson` argument.

```sh
osm_planet_extract --geojson=examples/test.geojson examples/san-francisco-downtown.osm.pbf
```

To draw bounding box polygons in GeoJSON, try the tool at http://geojson.io/. Currently, the bounding box for each feature is used. Future releases may support polygon clipping.

## Support

To report a bug, please [open an issue](https://github.com/interline-io/planetutils).

Interline Technologies also provides professional support and consulting services around this and other related tools. Contact us at info@interline.io for more information.
